# agent-approval-gate

Self-hosted approval gate for agent actions with a single-reply menu over Telegram or Email. No frontend.

## Core behavior
- When an agent wants to execute a side-effecting action, it creates an approval.
- A human replies once with a numeric menu choice (optionally with text).
- The gate returns approved/denied plus optional note/override.
- Supports per-session allow and permanent allow rules.

### Menu (one reply)
1) Allow once
2) Allow for this session
3) Deny
4) Allow once + add note (reply: 4 <text>)
5) Modify then allow (reply: 5 <replacement>)
6) Always allow this action type (until revoked)

Parsing rules:
- Trim whitespace; first token is the code (1..6), remainder is payload_text.
- Codes 4/5 require payload_text, otherwise invalid.

## 3-minute self-host (Docker Compose)
1) Copy environment file:
```bash
cp .env.example .env
```
2) Edit `.env` for API key, Telegram bot token (optional), SMTP (MailHog defaults).
3) Start:
```bash
docker compose up --build
```
4) Open API docs: `http://localhost:8000/docs` or `http://localhost:8000/openapi.json`.

## Configuration

### Auth
- `Authorization: Bearer <APPROVAL_API_KEY>`
- `client_id = sha256(api_key)[:12]`

### Telegram
- Set `TELEGRAM_BOT_TOKEN` to enable real sends.
- Set `TELEGRAM_MOCK=1` to disable network sends (tests and local dev).
- Bot message includes approval_id and menu. Inline buttons cover 1/2/3/6.

### Email
- SMTP config via `EMAIL_SMTP_*`.
- Subject includes `[appr_xxx]`; body includes approval_id and menu.
- Email reply ingestion is via `POST /v1/inbox/email-reply` (no IMAP required).

## API quickstart

Create approval (Telegram):
```bash
curl -sS -X POST http://localhost:8000/v1/approvals \
  -H 'Authorization: Bearer dev-key' \
  -H 'Content-Type: application/json' \
  -d '{
    "session_id": "sess_123",
    "action_type": "exec_cmd",
    "title": "Run command",
    "preview": "rm -rf ./build && npm run build",
    "channel": "telegram",
    "target": {"tg_chat_id": "123456789"},
    "expires_in_sec": 600
  }'
```

Create approval (Email):
```bash
curl -sS -X POST http://localhost:8000/v1/approvals \
  -H 'Authorization: Bearer dev-key' \
  -H 'Content-Type: application/json' \
  -d '{
    "session_id": "sess_123",
    "action_type": "http_request",
    "title": "POST request",
    "preview": "POST https://api.example.com/pay ...",
    "channel": "email",
    "target": {"email_to": "you@domain.com"},
    "expires_in_sec": 600
  }'
```

Poll approval status:
```bash
curl -sS -H 'Authorization: Bearer dev-key' \
  http://localhost:8000/v1/approvals/appr_xxx
```

Email reply ingestion (for email forwarder):
```bash
curl -sS -X POST http://localhost:8000/v1/inbox/email-reply \
  -H 'Authorization: Bearer dev-key' \
  -H 'Content-Type: application/json' \
  -d '{
    "subject": "Run command [appr_xxx]",
    "body": "4 please add logs\n\nOn Tue..."
  }'
```

Revoke allow rule:
```bash
curl -sS -X DELETE \
  -H 'Authorization: Bearer dev-key' \
  http://localhost:8000/v1/allow-rules/rule_xxx
```

## Agent integration (request -> poll)
Pseudo-flow:
1) POST /v1/approvals with session_id + action_type + preview.
2) Poll GET /v1/approvals/{approval_id} until status != pending.
3) If approved with `decision.override`, use the override; if denied, stop.

## Tests
```bash
pytest -q
```

E2E demo:
```bash
python scripts/e2e_demo.py
```

## Notes
- SQLite is the default storage (`data/data.db`).
- Session allow and allow rules auto-approve future requests before messaging.
- openapi.json is auto-generated by FastAPI at `/openapi.json`.
