<div align="center">

# ğŸ›¡ï¸ ok2run (Agent Approval Gate)

**ç»™é•¿æ—¶é—´è¿è¡Œçš„ AI Agent åŠ ä¸€é“â€œäººå·¥ç¡®è®¤â€çš„é—¸é—¨ï¼šä¸å®ˆåœ¨ç”µè„‘å‰ä¹Ÿèƒ½å®¡æ‰¹ã€‚**

[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)
[![Python](https://img.shields.io/badge/python-3.11+-blue.svg)](https://python.org)
[![Docker](https://img.shields.io/badge/docker-ready-blue.svg)](https://docker.com)

[English](README.md) | ä¸­æ–‡

<img src="https://img.shields.io/badge/Telegram-2CA5E0?style=for-the-badge&logo=telegram&logoColor=white" alt="Telegram"/>
<img src="https://img.shields.io/badge/Gmail-D14836?style=for-the-badge&logo=gmail&logoColor=white" alt="Email"/>

**ä¸€ä¸ªç»Ÿä¸€çš„å®¡æ‰¹å±‚ï¼Œæ¥å…¥å¤šä¸ª Agentï¼šè¯¥é—®äººçš„åœ°æ–¹å°±é—®äººï¼Œè€Œä¸æ˜¯å…¨è‡ªåŠ¨æ”¾è¡Œã€‚**

</div>

---

## ğŸ˜¤ é—®é¢˜

ä½ åœ¨è¿è¡Œä¸€ä¸ª AI Agentï¼ˆæ¯”å¦‚ Claude Code æˆ–è‡ªå·±å¼€å‘çš„ï¼‰ï¼Œå®ƒéœ€è¦æƒé™ï¼š

```
ğŸ¤– Agent æƒ³è¦æ‰§è¡Œ: rm -rf ./build
   ç­‰å¾…å®¡æ‰¹ä¸­...
```

ä½†ä½ ï¼š
- ğŸ§‘â€ğŸ’¼ åœ¨å¼€ä¼š/ä¸Šè¯¾ï¼Œä¸æ–¹ä¾¿å›ç»ˆç«¯ç‚¹ç¡®è®¤
- ğŸ–ï¸ æ­£åœ¨æ‘¸é±¼ï¼ˆä¸æƒ³ä¸€ç›´ç›¯ç€ç”µè„‘ï¼‰
- ğŸš‡ åœ¨è·¯ä¸Š/é€šå‹¤

**ä½ çš„ Agent å¡ä½äº†ã€‚ç­‰ç€ã€‚ä»€ä¹ˆéƒ½åšä¸äº†ã€‚**

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

<div align="center">

**Telegram / é‚®ç®±ä¸€é”®å®¡æ‰¹ã€‚éšæ—¶éšåœ°ã€‚**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¤– Claude Code æƒ³è¦æ‰§è¡Œ:          â”‚
â”‚                                    â”‚
â”‚  rm -rf ./build                    â”‚
â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   âœ…   â”‚ â”‚   âŒ   â”‚ â”‚   â™¾ï¸   â”‚  â”‚
â”‚  â”‚  æ‰¹å‡†  â”‚ â”‚  æ‹’ç»  â”‚ â”‚  æ°¸ä¹…  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</div>

---

## âœ¨ ç‰¹æ€§

| ç‰¹æ€§ | æè¿° |
|------|------|
| ğŸ“± **è¿œç¨‹å®¡æ‰¹** | Telegram / Email éšæ—¶éšåœ°ä¸€é”®å®¡æ‰¹ |
| âš¡ **ä¸€é”®æŒ‰é’®** | ä¸ç”¨æ‰“å­—ï¼Œç‚¹ä¸€ä¸‹å°±è¡Œ |
| ğŸ§© **ç»Ÿä¸€ç®¡ç†** | å¤šä¸ª Agent å…±ç”¨ä¸€å¥—å®¡æ‰¹è§„åˆ™/æ”¾è¡Œç­–ç•¥ |
| ğŸ  **è‡ªæ‰˜ç®¡** | ä½ çš„æ•°æ®ï¼Œä½ çš„æœåŠ¡å™¨ |
| ğŸ³ **Docker å°±ç»ª** | `docker compose up -d` æå®š |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å…‹éš† & é…ç½®

```bash
git clone https://github.com/Narcooo/ok2run.git
cd ok2run
cp .env.example .env
```

### 2. è·å– Telegram Bot Token

1. ç»™ [@BotFather](https://t.me/BotFather) å‘æ¶ˆæ¯ â†’ `/newbot`
2. æŠŠ token å¤åˆ¶åˆ° `.env`
3. ç»™ä½ çš„æ–°æœºå™¨äººå‘é€ `/start`
4. è·å– chat ID: `https://api.telegram.org/bot<TOKEN>/getUpdates`

### 3. è¿è¡Œ

```bash
# æ–¹å¼ A: Dockerï¼ˆæ¨èï¼‰
docker compose up -d

# æ–¹å¼ B: æœ¬åœ°è¿è¡Œ
pip install -e .
python -m uvicorn agent_approval_gate.main:app --port 8000
```

### 4. è®¾ç½® Webhookï¼ˆTelegramï¼‰

```bash
# å¦‚æœä½ æœ‰å…¬ç½‘ URLï¼ˆngrokã€VPS ç­‰ï¼‰
curl -X POST http://localhost:8000/v1/telegram/setup-webhook \
  -H "Authorization: Bearer your-api-key"
```

---

## ğŸ”§ é›†æˆæ–¹å¼

### Claude Code - å®Œå…¨æ¥ç®¡ â­

**ç”¨ Telegram å®¡æ‰¹æ›¿æ¢æ‰€æœ‰æƒé™å¯¹è¯æ¡†ã€‚**

æ·»åŠ åˆ° `~/.claude/settings.json`ï¼š

```json
{
  "hooks": {
    "PermissionRequest": [{
      "matcher": "*",
      "hooks": [{
        "type": "command",
        "command": "APPROVAL_GATE_URL=http://127.0.0.1:8000 APPROVAL_API_KEY=dev-key APPROVAL_TG_CHAT_ID=YOUR_CHAT_ID python3 /path/to/scripts/cc_permission_hook.py",
        "timeout": 300
      }]
    }]
  }
}
```

ç°åœ¨å»å–æ¯å’–å•¡å§ã€‚Agent ä¼šåœ¨ Telegram ä¸Šæ‰¾ä½ ã€‚â˜•

> **æ³¨æ„ï¼š** `.claude/settings.local.json` ä¸­ `permissions.allow` é‡Œçš„å‘½ä»¤ä¼šç»•è¿‡ hookï¼Œä¸ä¼šå‘é€åˆ° Telegramã€‚å¦‚æœæƒ³è®©æ‰€æœ‰å‘½ä»¤éƒ½èµ°å®¡æ‰¹ï¼Œéœ€è¦æ¸…ç©º allow åˆ—è¡¨æˆ–ç§»é™¤ä½ æƒ³æ§åˆ¶çš„å‘½ä»¤ã€‚

---

### MCP å·¥å…·ï¼ˆæ”¯æŒ MCP çš„å®¢æˆ·ç«¯ï¼‰

å¦‚æœä½ çš„ Agent/å®¢æˆ·ç«¯æ”¯æŒ MCPï¼ˆä¾‹å¦‚ Claude Codeï¼‰ï¼Œå¯ä»¥ç”¨ MCP server å‘èµ·â€œæ˜¾å¼å®¡æ‰¹è¯·æ±‚â€ã€‚ä¸æ”¯æŒ MCP çš„è¯ï¼Œç›´æ¥ç”¨ä¸‹é¢çš„ HTTP APIã€‚

åœ¨ Claude Code é‡Œé…ç½® `.mcp.json`ï¼š

```json
{
  "mcpServers": {
    "approval-gate": {
      "command": "python",
      "args": ["/path/to/mcp_server.py"],
      "env": {
        "APPROVAL_GATE_URL": "http://127.0.0.1:8000",
        "APPROVAL_API_KEY": "your-key",
        "APPROVAL_TG_CHAT_ID": "your-chat-id"
      }
    }
  }
}
```

**å¯ç”¨å·¥å…·ï¼š**

| å·¥å…· | åŠŸèƒ½ |
|------|------|
| `execute_approved` | è·å–å®¡æ‰¹ â†’ æ‰§è¡Œå‘½ä»¤ï¼ˆç»•è¿‡å¯¹è¯æ¡†ï¼‰ |
| `ask_user` | å‘ç”¨æˆ·æé—®ï¼ˆA/B/C/D é€‰é¡¹ï¼‰ |
| `request_approval` | è¯·æ±‚å®¡æ‰¹ï¼Œè·å– ID |
| `wait_for_approval` | ç­‰å¾…ç”¨æˆ·å†³å®š |

---

### HTTP APIï¼ˆä»»æ„ Agentï¼‰

é€‚ç”¨äº**ä»»ä½•èƒ½å‘ HTTP è¯·æ±‚çš„è‡ªä¸» Agent**ï¼š

```python
# Python ç¤ºä¾‹
import requests

# 1. è¯·æ±‚å®¡æ‰¹
resp = requests.post("http://localhost:8000/v1/approvals",
    headers={"Authorization": "Bearer your-key"},
    json={
        "session_id": "my-agent-session",
        "action_type": "file_delete",
        "title": "åˆ é™¤ build æ–‡ä»¶å¤¹",
        "preview": "rm -rf ./build",
        "channel": "telegram",
        "target": {"tg_chat_id": "123456789"}
    })
approval_id = resp.json()["approval_id"]

# 2. ç­‰å¾…ç”¨æˆ·å†³å®š
while True:
    status = requests.get(f"http://localhost:8000/v1/approvals/{approval_id}",
        headers={"Authorization": "Bearer your-key"}).json()
    if status["status"] != "pending":
        break
    time.sleep(2)

# 3. å¦‚æœæ‰¹å‡†åˆ™æ‰§è¡Œ
if status["status"] == "approved":
    os.system("rm -rf ./build")
```

**æˆ–è€…ç”¨ curlï¼š**

```bash
# åˆ›å»ºå®¡æ‰¹è¯·æ±‚
curl -X POST http://localhost:8000/v1/approvals \
  -H "Authorization: Bearer your-key" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "my-agent",
    "action_type": "bash",
    "title": "åˆ é™¤ build æ–‡ä»¶å¤¹",
    "preview": "rm -rf ./build",
    "channel": "telegram",
    "target": {"tg_chat_id": "123456789"}
  }'

# è½®è¯¢ç»“æœ
curl http://localhost:8000/v1/approvals/appr_xxx \
  -H "Authorization: Bearer your-key"
```

---

## ğŸ“± å®¡æ‰¹æŒ‰é’®

### æ ‡å‡†æ¨¡å¼
| æŒ‰é’® | æ“ä½œ |
|------|------|
| âœ… æ‰¹å‡† | å…è®¸æœ¬æ¬¡ |
| âœ… ä¼šè¯ | å…è®¸æœ¬ä¼šè¯ |
| âŒ æ‹’ç» | æ‹’ç» |
| â™¾ï¸ æ°¸ä¹… | æ°¸ä¹…å…è®¸æ­¤ç±»æ“ä½œ |

### é—®ç­”æ¨¡å¼
| æŒ‰é’® | æ“ä½œ |
|------|------|
| A / B / C / D | é€‰æ‹©é€‰é¡¹ |
| ğŸ“ è‡ªå®šä¹‰ | è¾“å…¥è‡ªå®šä¹‰å›å¤ |

---

## ğŸ³ Docker

```bash
# å¯åŠ¨
docker compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f

# åœæ­¢
docker compose down
```

---

## ğŸ“ ç¯å¢ƒå˜é‡

```bash
# å¿…éœ€
APPROVAL_API_KEY=your-secret-key
TELEGRAM_BOT_TOKEN=123456:ABC...
APPROVAL_TG_CHAT_ID=your-chat-id

# å¯é€‰ï¼šEmail
EMAIL_SMTP_HOST=smtp.gmail.com
EMAIL_SMTP_PORT=587
EMAIL_FROM=you@gmail.com
EMAIL_USERNAME=you@gmail.com
EMAIL_PASSWORD=app-password

# å¯é€‰ï¼šé‚®ä»¶ä¸€é”®æŒ‰é’®éœ€è¦
PUBLIC_URL=https://your-domain.com
```

---

## ğŸ”— ä¸ºä»€ä¹ˆåšè¿™ä¸ª

èƒ½é•¿æ—¶é—´è·‘çš„ Agent åªä¼šè¶Šæ¥è¶Šå¤šã€‚å®ƒä»¬è¶Šèƒ½å¹²ï¼Œè¶Šéœ€è¦åœ¨â€œæœ‰å‰¯ä½œç”¨â€çš„åŠ¨ä½œå‰åœä¸€ä¸‹é—®äººï¼šè¦ä¸è¦æ‰§è¡Œè¿™æ¡å‘½ä»¤ï¼Ÿè¦ä¸è¦æ”¹è¿™ä¸ªæ–‡ä»¶ï¼Ÿè¦ä¸è¦å‘è¿™æ¬¡å¤–éƒ¨è¯·æ±‚ï¼Ÿ

ok2run çš„çµæ„Ÿæ¥è‡ª [Moltbot](https://github.com/moltbot/moltbot)ã€‚æŠŠâ€œæƒé™ç¡®è®¤â€è¿™ä»¶äº‹åšæˆä¸€ä¸ªç‹¬ç«‹ã€é€šç”¨ã€å¯è‡ªæ‰˜ç®¡çš„ç»„ä»¶ï¼šæ¥å…¥ä¸åŒ Agentï¼ŒæŠŠâ€œè¯¥ä¸è¯¥åšâ€é›†ä¸­åˆ°åŒä¸€ä¸ªåœ°æ–¹ç®¡ç†ï¼ˆTelegram/é‚®ç®±ä¸€é”®å®¡æ‰¹ï¼‰ã€‚

**ä¹Ÿé€‚ç”¨äºï¼š** [Claude Code](https://docs.anthropic.com/en/docs/claude-code)ï¼ˆAnthropic çš„ CLI Agentï¼‰


<div align="center">

**å¦‚æœè¿™ä¸ªé¡¹ç›®è®©ä½ ä¸ç”¨å†ç›¯ç€ç»ˆç«¯ï¼Œç»™ä¸ª â­ å§**

</div>
